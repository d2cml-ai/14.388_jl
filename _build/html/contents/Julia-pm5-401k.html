
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models &#8212; My sample book</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">My sample book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Julia_Notebook_Linear_Model_Overfitting.html">
   Simple Exercise on Overfitting
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/contents/Julia-pm5-401k.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fcontents/Julia-pm5-401k.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/contents/Julia-pm5-401k.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#impact-of-401-k-on-financial-wealth">
   Impact of 401(k) on Financial Wealth
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-the-ate-of-401-k-eligibility-on-financial-assets">
   Estimating the ATE of 401(k) Eligibility on Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#partially-linear-regression-models-plr">
   Partially Linear Regression Models (PLR)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-regression-model-irm">
   Interactive Regression Model (IRM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
   Local Average Treatment Effects of 401(k) Participation on Net Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-iv-model-iivm">
   Interactive IV Model (IIVM)
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#impact-of-401-k-on-financial-wealth">
   Impact of 401(k) on Financial Wealth
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-the-ate-of-401-k-eligibility-on-financial-assets">
   Estimating the ATE of 401(k) Eligibility on Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#partially-linear-regression-models-plr">
   Partially Linear Regression Models (PLR)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-regression-model-irm">
   Interactive Regression Model (IRM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
   Local Average Treatment Effects of 401(k) Participation on Net Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-iv-model-iivm">
   Interactive IV Model (IIVM)
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models">
<h1>Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models<a class="headerlink" href="#inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models" title="Permalink to this headline">#</a></h1>
<section id="impact-of-401-k-on-financial-wealth">
<h2>Impact of 401(k) on Financial Wealth<a class="headerlink" href="#impact-of-401-k-on-financial-wealth" title="Permalink to this headline">#</a></h2>
<p>As a practical illustration of the methods developed in this lecture, we consider estimation of the effect of 401(k) eligibility and participation on accumulated assets. 401(k) plans are pension accounts sponsored by employers. The key problem in determining the effect of participation in 401(k) plans on accumulated assets is saver heterogeneity coupled with the fact that the decision to enroll in a 401(k) is non-random. It is generally recognized that some people have a higher preference for saving than others. It also seems likely that those individuals with high unobserved preference for saving would be most likely to choose to participate in tax-advantaged retirement savings plans and would tend to have otherwise high amounts of accumulated assets. The presence of unobserved savings preferences with these properties then implies that conventional estimates that do not account for saver heterogeneity and endogeneity of participation will be biased upward, tending to overstate the savings effects of 401(k) participation.</p>
<p>One can argue that eligibility for enrolling in a 401(k) plan in this data can be taken as exogenous after conditioning on a few observables of which the most important for their argument is income. The basic idea is that, at least around the time 401(k)’s initially became available, people were unlikely to be basing their employment decisions on whether an employer offered a 401(k) but would instead focus on income and other aspects of the job.</p>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h3>
<p>The data set comes from the <code class="docutils literal notranslate"><span class="pre">hdm</span></code> R package, and is loaded in Julia using the <code class="docutils literal notranslate"><span class="pre">RData</span></code> package</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">RData</span><span class="p">,</span> <span class="n">CSV</span><span class="p">,</span> <span class="n">DataFrames</span><span class="p">,</span> <span class="n">StatsBase</span><span class="p">,</span> <span class="n">Gadfly</span><span class="p">,</span> <span class="n">StatsModels</span><span class="p">,</span> <span class="n">GLM</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">rdata</span> <span class="o">=</span> <span class="n">RData</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;../data/pension.RData&quot;</span><span class="p">,</span> <span class="n">convert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">ArgumentError</span>: No file exists at given path: ../data/pension.RData

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">checkpath_load</span>
   <span class="o">@</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Work</span>\<span class="o">.</span><span class="n">julia</span>\<span class="n">packages</span>\<span class="n">FileIO</span>\<span class="n">Nl9Lh</span>\<span class="n">src</span>\<span class="n">loadsave</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">167</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">load</span><span class="p">(::</span><span class="n">String</span><span class="p">;</span> <span class="n">options</span><span class="p">::</span><span class="n">Base</span><span class="o">.</span><span class="n">Pairs</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">Symbol</span><span class="p">},</span> <span class="n">NamedTuple</span><span class="p">{(:</span><span class="n">convert</span><span class="p">,),</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">Bool</span><span class="p">}}})</span>
   <span class="o">@</span> <span class="n">FileIO</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Work</span>\<span class="o">.</span><span class="n">julia</span>\<span class="n">packages</span>\<span class="n">FileIO</span>\<span class="n">Nl9Lh</span>\<span class="n">src</span>\<span class="n">loadsave</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">110</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">1</span>
 <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="nb">eval</span>
   <span class="o">@</span> <span class="o">.</span>\<span class="n">boot</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">373</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">include_string</span><span class="p">(</span><span class="n">mapexpr</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">REPL</span><span class="o">.</span><span class="n">softscope</span><span class="p">),</span> <span class="n">mod</span><span class="p">::</span><span class="n">Module</span><span class="p">,</span> <span class="n">code</span><span class="p">::</span><span class="n">String</span><span class="p">,</span> <span class="n">filename</span><span class="p">::</span><span class="n">String</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Base</span> <span class="o">.</span>\<span class="n">loading</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">1196</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">rdata</span><span class="p">[</span><span class="s">&quot;pension&quot;</span><span class="p">]);</span>
<span class="n">categorical!</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="ss">:e401</span><span class="p">,</span> <span class="ss">:p401</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<p>The data consist of 9,915 observations at the household level drawn from the 1991 Survey of Income and Program Participation (SIPP).  All the variables are referred to 1990. We use net financial assets (<em>net_tfa</em>) as the outcome variable, <span class="math notranslate nohighlight">\(Y\)</span>,  in our analysis. The net financial assets are computed as the sum of IRA balances, 401(k) balances, checking accounts, saving bonds, other interest-earning accounts, other interest-earning assets, stocks, and mutual funds less non mortgage debts.</p>
<p>Among the <span class="math notranslate nohighlight">\(9915\)</span> individuals, <span class="math notranslate nohighlight">\(3682\)</span> are eligible to participate in the program. The variable <em>e401</em> indicates eligibility and <em>p401</em> indicates participation, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">]</span> <span class="o">.=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">e_count</span> <span class="o">=</span> <span class="n">combine</span><span class="p">(</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="ss">:e401</span><span class="p">),</span> <span class="ss">:n</span> <span class="o">=&gt;</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="ss">:Freq</span><span class="p">);</span>
<span class="n">plot</span><span class="p">(</span><span class="n">e_count</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="ss">:e401</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="ss">:Freq</span><span class="p">,</span> <span class="n">Geom</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="ss">:dodge</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Eligibility is highly associated with financial wealth:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="ss">:net_tfa</span><span class="p">,</span> <span class="n">xgroup</span><span class="o">=</span><span class="ss">:e401</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="ss">:e401</span><span class="p">,</span> <span class="n">Geom</span><span class="o">.</span><span class="n">subplot_grid</span><span class="p">(</span><span class="n">Geom</span><span class="o">.</span><span class="n">density</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>The unconditional APE of e401 is about <span class="math notranslate nohighlight">\(19559\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">e401</span> <span class="o">.==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">:</span><span class="p">];</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">e401</span> <span class="o">.==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">:</span><span class="p">];</span>
<span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">net_tfa</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">net_tfa</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19559.0
</pre></div>
</div>
</div>
</div>
<p>Among the <span class="math notranslate nohighlight">\(3682\)</span> individuals that are eligible, <span class="math notranslate nohighlight">\(2594\)</span> decided to participate in the program. The unconditional APE of p401 is about <span class="math notranslate nohighlight">\(27372\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">p1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">p401</span> <span class="o">.==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">:</span><span class="p">];</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">p401</span> <span class="o">.==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">:</span><span class="p">];</span>
<span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">net_tfa</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">net_tfa</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>27372.0
</pre></div>
</div>
</div>
</div>
<p>As discussed, these estimates are biadsed since they don’t account for saver heterogeneity and endogeneity of participation.</p>
</section>
</section>
<section id="estimating-the-ate-of-401-k-eligibility-on-financial-assets">
<h2>Estimating the ATE of 401(k) Eligibility on Financial Assets<a class="headerlink" href="#estimating-the-ate-of-401-k-eligibility-on-financial-assets" title="Permalink to this headline">#</a></h2>
<p>We first look at the treatment effect of e401 on net total financial assets. We give estimates of the ATE and ATT that corresponds to the linear model</p>
<div class="math notranslate nohighlight">
\[
Y = D\alpha + f(X)'\beta + \epsilon,
\]</div>
<p>where  <span class="math notranslate nohighlight">\(f(X)\)</span>  includes indicators of marital status, two-earner status, defined benefit pension status, IRA participation status, and home ownership status, and orthogonal polynomials of degrees 2, 4, 6 and 8 in family size, education, age and income, respectively. The dimensions of  <span class="math notranslate nohighlight">\(f(X)\)</span>  is 25.</p>
<p>In the first step, we report estimates of the average treatment effect (ATE) of 401(k) eligibility on net financial assets both in the partially linear regression (PLR) model and in the interactive regression model (IRM) allowing for heterogeneous treatment effects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># We define the `poly` function as provided by the documentation of the `StatsModels` package:</span>

<span class="c"># syntax: best practice to define a _new_ function</span>
<span class="n">poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">^</span><span class="n">n</span>

<span class="c"># type of model where syntax applies: here this applies to any model type</span>
<span class="k">const</span> <span class="n">POLY_CONTEXT</span> <span class="o">=</span> <span class="kt">Any</span>

<span class="c"># struct for behavior</span>
<span class="k">struct</span> <span class="kt">PolyTerm</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="kt">D</span><span class="p">}</span> <span class="o">&lt;:</span> <span class="kt">AbstractTerm</span>
    <span class="n">term</span><span class="o">::</span><span class="kt">T</span>
    <span class="n">deg</span><span class="o">::</span><span class="kt">D</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="kt">IO</span><span class="p">,</span> <span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">)</span> <span class="o">=</span> <span class="n">print</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;poly(</span><span class="si">$</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">term</span><span class="p">)</span><span class="s">, </span><span class="si">$</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="s">)&quot;</span><span class="p">)</span>

<span class="c"># for `poly` use at run-time (outside @formula), return a schema-less PolyTerm</span>
<span class="n">poly</span><span class="p">(</span><span class="n">t</span><span class="o">::</span><span class="kt">Symbol</span><span class="p">,</span> <span class="n">d</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span> <span class="o">=</span> <span class="n">PolyTerm</span><span class="p">(</span><span class="n">term</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">term</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

<span class="c"># for `poly` use inside @formula: create a schemaless PolyTerm and apply_schema</span>
<span class="k">function</span> <span class="n">StatsModels</span><span class="o">.</span><span class="n">apply_schema</span><span class="p">(</span><span class="n">t</span><span class="o">::</span><span class="kt">FunctionTerm</span><span class="p">{</span><span class="kt">typeof</span><span class="p">(</span><span class="kt">poly</span><span class="p">)},</span>
                                  <span class="n">sch</span><span class="o">::</span><span class="kt">StatsModels</span><span class="o">.</span><span class="n">Schema</span><span class="p">,</span>
                                  <span class="n">Mod</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="o">&lt;:</span><span class="kt">POLY_CONTEXT</span><span class="p">})</span>
    <span class="n">apply_schema</span><span class="p">(</span><span class="n">PolyTerm</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">args_parsed</span><span class="o">...</span><span class="p">),</span> <span class="n">sch</span><span class="p">,</span> <span class="n">Mod</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># apply_schema to internal Terms and check for proper types</span>
<span class="k">function</span> <span class="n">StatsModels</span><span class="o">.</span><span class="n">apply_schema</span><span class="p">(</span><span class="n">t</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">,</span>
                                  <span class="n">sch</span><span class="o">::</span><span class="kt">StatsModels</span><span class="o">.</span><span class="n">Schema</span><span class="p">,</span>
                                  <span class="n">Mod</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="o">&lt;:</span><span class="kt">POLY_CONTEXT</span><span class="p">})</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">apply_schema</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">sch</span><span class="p">,</span> <span class="n">Mod</span><span class="p">)</span>
    <span class="k">isa</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ContinuousTerm</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">throw</span><span class="p">(</span><span class="kt">ArgumentError</span><span class="p">(</span><span class="s">&quot;PolyTerm only works with continuous terms (got </span><span class="si">$term</span><span class="s">)&quot;</span><span class="p">))</span>
    <span class="k">isa</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">ConstantTerm</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">throw</span><span class="p">(</span><span class="kt">ArgumentError</span><span class="p">(</span><span class="s">&quot;PolyTerm degree must be a number (got </span><span class="si">$t</span><span class="s">.deg)&quot;</span><span class="p">))</span>
    <span class="n">PolyTerm</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">StatsModels</span><span class="o">.</span><span class="n">modelcols</span><span class="p">(</span><span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">,</span> <span class="n">d</span><span class="o">::</span><span class="kt">NamedTuple</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">modelcols</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">reduce</span><span class="p">(</span><span class="n">hcat</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="o">.^</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">p</span><span class="o">.</span><span class="n">deg</span><span class="p">])</span>
<span class="k">end</span>

<span class="c"># the basic terms contained within a PolyTerm (for schema extraction)</span>
<span class="n">StatsModels</span><span class="o">.</span><span class="n">terms</span><span class="p">(</span><span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">)</span> <span class="o">=</span> <span class="n">terms</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">term</span><span class="p">)</span>
<span class="c"># names variables from the data that a PolyTerm relies on</span>
<span class="n">StatsModels</span><span class="o">.</span><span class="n">termvars</span><span class="p">(</span><span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">)</span> <span class="o">=</span> <span class="n">StatsModels</span><span class="o">.</span><span class="n">termvars</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">term</span><span class="p">)</span>
<span class="c"># number of columns in the matrix this term produces</span>
<span class="n">StatsModels</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">deg</span>

<span class="n">StatsBase</span><span class="o">.</span><span class="n">coefnames</span><span class="p">(</span><span class="n">p</span><span class="o">::</span><span class="kt">PolyTerm</span><span class="p">)</span> <span class="o">=</span> <span class="n">coefnames</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="o">.*</span> <span class="s">&quot;^&quot;</span> <span class="o">.*</span> <span class="n">string</span><span class="o">.</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">p</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

<span class="c"># output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#Constructing the Data</span>

<span class="n">formula_flex</span> <span class="o">=</span> <span class="nd">@formula</span><span class="p">(</span><span class="n">net_tfa</span> <span class="o">~</span> <span class="n">e401</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">educ</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">fsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">marr</span> <span class="o">+</span> <span class="n">twoearn</span> <span class="o">+</span> <span class="n">db</span> <span class="o">+</span> <span class="n">pira</span> <span class="o">+</span> <span class="n">hown</span><span class="p">);</span>
<span class="n">formula_flex</span> <span class="o">=</span> <span class="n">apply_schema</span><span class="p">(</span><span class="n">formula_flex</span><span class="p">,</span> <span class="n">schema</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">modelcols</span><span class="p">(</span><span class="n">formula_flex</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="n">y</span> <span class="o">=</span> <span class="kt">Float64</span><span class="o">.</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="n">Not</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span>
<span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25
</pre></div>
</div>
</div>
</div>
</section>
<section id="partially-linear-regression-models-plr">
<h2>Partially Linear Regression Models (PLR)<a class="headerlink" href="#partially-linear-regression-models-plr" title="Permalink to this headline">#</a></h2>
<p>We start using lasso to estimate the function <span class="math notranslate nohighlight">\(g_0\)</span> and <span class="math notranslate nohighlight">\(m_0\)</span> in the following PLR model:</p>
<div class="math notranslate nohighlight">
\[
Y = D\theta_0 + g_0(X) + \zeta, E[\zeta | D, X] = 0,
\]</div>
<div class="math notranslate nohighlight">
\[
D = m_0(X) + V, E[V| X] = 0.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">MLDataUtils</span><span class="p">,</span> <span class="n">MLBase</span><span class="p">,</span> <span class="n">Random</span><span class="p">,</span> <span class="n">FixedEffectModels</span><span class="p">,</span> <span class="n">GLMNet</span>

<span class="k">function</span> <span class="n">DML2_for_PLM</span><span class="p">(</span><span class="n">x</span> <span class="p">,</span> <span class="n">d</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span> <span class="p">,</span> <span class="n">yreg</span> <span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Num ob observations</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Define folds indices </span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Create array to save errors </span>
    <span class="n">ytil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">dtil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="n">dl</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span> <span class="p">[(</span><span class="n">d</span> <span class="o">.&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">(</span><span class="n">d</span> <span class="o">.&gt;=</span> <span class="mf">0.5</span><span class="p">)])</span>
    
    <span class="c"># loop to save results</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        
        <span class="c"># Lasso regression, excluding folds selected </span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">dreg</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">dl</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">yreg</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict estimates using the </span>
        <span class="n">dhat</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">],</span> <span class="n">outtype</span> <span class="o">=</span> <span class="ss">:prob</span><span class="p">)</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">])</span>
        
        <span class="c"># Save errors </span>
        <span class="n">dtil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">dhat</span><span class="p">)</span>
        <span class="n">ytil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c"># Create dataframe </span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">ytil</span> <span class="o">=</span> <span class="n">ytil</span><span class="p">,</span> <span class="n">dtil</span> <span class="o">=</span> <span class="n">dtil</span><span class="p">)</span>
    
    <span class="c"># OLS clustering at the County level</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">dtil</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ytil</span><span class="p">)</span>
    <span class="c"># coef_est = coef(rfit)[2]</span>
    <span class="c"># se = FixedEffectModels.coeftable(rfit).cols[2][2]</span>

    <span class="c"># println(&quot; coef (se) = &quot;, coef_est ,&quot;(&quot;,se,&quot;)&quot;)</span>
    
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DML2_for_PLM (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Estimating the PLR</span>

<span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Binomial</span><span class="p">())</span>
<span class="n">yreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">lasso_fit</span><span class="p">,</span> <span class="n">lasso_data</span> <span class="o">=</span> <span class="n">DML2_for_PLM</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span><span class="p">,</span> <span class="n">yreg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">lasso_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  6536.48     1250.23  5.23    &lt;1e-06    4085.77    8987.19
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<p>Let us check the predictive performance of the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># cross-fitted RMSE: outcome</span>
<span class="n">lasso_y_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">((</span><span class="n">lasso_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">.-</span> <span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">lasso_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lasso_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>55738.19944273792
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># cross-fitted RMSE: treatment</span>

<span class="n">lasso_d_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">lasso_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">));</span>

<span class="n">println</span><span class="p">(</span><span class="n">lasso_d_rmse</span><span class="p">)</span>

<span class="c"># cross-fitted ce: treatment</span>

<span class="n">mean</span><span class="p">(</span><span class="n">ifelse</span><span class="o">.</span><span class="p">(</span><span class="n">d</span> <span class="o">.-</span> <span class="n">lasso_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.!=</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.44775159135451154
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31860816944024206
</pre></div>
</div>
</div>
</div>
<p>Then we repeat this proceedure for various machine learning methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Random Forrest</span>

<span class="k">using</span> <span class="n">DecisionTree</span>

<span class="k">function</span> <span class="n">DML2_RF</span><span class="p">(</span><span class="n">z</span> <span class="p">,</span> <span class="n">d</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span> <span class="p">,</span> <span class="n">yreg</span> <span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Num ob observations</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Define folds indices</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Create array to save errors </span>
    <span class="n">ytil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">dtil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># loop to save results</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">dreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">yreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">dhat</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">])</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">])</span>
        <span class="n">dtil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">dhat</span><span class="p">)</span>
        <span class="n">ytil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c"># Create dataframe </span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">ytil</span> <span class="o">=</span> <span class="n">ytil</span><span class="p">,</span> <span class="n">dtil</span> <span class="o">=</span> <span class="n">dtil</span><span class="p">)</span>
    
    <span class="c"># OLS clustering at the County level</span>
    <span class="c"># rfit = reg(data, @formula(ytil ~ dtil))</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">dtil</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ytil</span><span class="p">)</span>
    <span class="c"># coef_est = coef(rfit)[1]</span>
    <span class="c"># se = FixedEffectModels.coeftable(rfit).cols[2]</span>

    <span class="c"># println(&quot; coef (se) = &quot;, coef_est ,&quot;(&quot;,se,&quot;)&quot;)</span>
    
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DML2_RF (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3-element Vector{Any}:
 [2, 4, 6, 8, 9, 11, 12, 13, 14, 16  …  9901, 9903, 9904, 9905, 9908, 9909, 9910, 9911, 9914, 9915]
 [1, 3, 5, 7, 8, 9, 10, 12, 13, 15  …  9900, 9902, 9903, 9905, 9906, 9907, 9910, 9912, 9913, 9915]
 [1, 2, 3, 4, 5, 6, 7, 10, 11, 14  …  9902, 9904, 9906, 9907, 9908, 9909, 9911, 9912, 9913, 9914]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">size</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3305
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">dreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">yreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">rf_fit</span><span class="p">,</span> <span class="n">rf_data</span> <span class="o">=</span> <span class="n">DML2_RF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span><span class="p">,</span> <span class="n">yreg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">rf_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  8753.48      1214.5  7.21    &lt;1e-12    6372.81    11134.2
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<p>We can compare the accuracy of this model to the model that was estimated with lasso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">rf_y_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">((</span><span class="n">rf_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">.-</span> <span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">rf_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rf_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">rf_d_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">rf_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">println</span><span class="p">(</span><span class="n">rf_y_rmse</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="n">rf_d_rmse</span><span class="p">)</span>

<span class="n">mean</span><span class="p">(</span><span class="n">ifelse</span><span class="o">.</span><span class="p">(</span><span class="n">d</span> <span class="o">.-</span> <span class="n">rf_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.!=</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>56226.390040126214
0.46496145990094206
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3447302067574382
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Trees</span>

<span class="k">function</span> <span class="n">DML2_Tree</span><span class="p">(</span><span class="n">z</span> <span class="p">,</span> <span class="n">d</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span> <span class="p">,</span> <span class="n">yreg</span> <span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Num ob observations</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Define folds indices</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Create array to save errors </span>
    <span class="n">ytil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">dtil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># loop to save results</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">dreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">yreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">dhat</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">])</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="o">:</span><span class="p">])</span>
        <span class="n">dtil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">dhat</span><span class="p">)</span>
        <span class="n">ytil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c"># Create dataframe </span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">ytil</span> <span class="o">=</span> <span class="n">ytil</span><span class="p">,</span> <span class="n">dtil</span> <span class="o">=</span> <span class="n">dtil</span><span class="p">)</span>
    
    <span class="c"># OLS clustering at the County level</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">dtil</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ytil</span><span class="p">)</span>
    <span class="c"># coef_est = coef(rfit)[1]</span>
    <span class="c"># se = FixedEffectModels.coeftable(rfit).cols[2]</span>

    <span class="c"># println(&quot; coef (se) = &quot;, coef_est ,&quot;(&quot;,se,&quot;)&quot;)</span>
    
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DML2_Tree (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">dreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">yreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="n">tree_fit</span><span class="p">,</span> <span class="n">tree_data</span> <span class="o">=</span> <span class="n">DML2_Tree</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span><span class="p">,</span> <span class="n">yreg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">tree_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  8205.33     1320.35  6.21    &lt;1e-09    5617.18    10793.5
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">tree_y_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">((</span><span class="n">tree_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">.-</span> <span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">tree_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tree_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">tree_d_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">tree_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">println</span><span class="p">(</span><span class="n">tree_y_rmse</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="n">tree_d_rmse</span><span class="p">)</span>

<span class="n">mean</span><span class="p">(</span><span class="n">ifelse</span><span class="o">.</span><span class="p">(</span><span class="n">d</span> <span class="o">.-</span> <span class="n">tree_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.!=</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>59676.120532917645
0.45392774217158094
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.34664649520927887
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Boosting</span>

<span class="k">using</span> <span class="n">XGBoost</span>

<span class="k">function</span> <span class="n">DML2_Boost</span><span class="p">(</span><span class="n">z</span> <span class="p">,</span> <span class="n">d</span> <span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span> <span class="p">,</span> <span class="n">yreg</span> <span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Num ob observations</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Define folds indices</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Create array to save errors </span>
    <span class="n">ytil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">dtil</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># loop to save results</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">dreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">yreg</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">dhat</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">yfit</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">dtil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">dhat</span><span class="p">)</span>
        <span class="n">ytil</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">-</span> <span class="n">yhat</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c"># Create dataframe </span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">ytil</span> <span class="o">=</span> <span class="n">ytil</span><span class="p">,</span> <span class="n">dtil</span> <span class="o">=</span> <span class="n">dtil</span><span class="p">)</span>
    
    <span class="c"># OLS clustering at the County level</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">dtil</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ytil</span><span class="p">)</span>
    <span class="c"># coef_est = coef(rfit)[1]</span>
    <span class="c"># se = FixedEffectModels.coeftable(rfit).cols[2]</span>

    <span class="c"># println(&quot; coef (se) = &quot;, coef_est ,&quot;(&quot;,se,&quot;)&quot;)</span>
    
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DML2_Boost (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">dreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s">&quot;logloss&quot;</span><span class="p">);</span>
<span class="n">yreg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">y</span><span class="p">);</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span> <span class="o">=</span> <span class="n">DML2_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dreg</span><span class="p">,</span> <span class="n">yreg</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1]	train-logloss:0.62814512403397260
[2]	train-logloss:0.59143994323424598
[3]	train-logloss:0.56518430078399340
[4]	train-logloss:0.54780421759510545
[5]	train-logloss:0.53631460053477098
[1]	train-rmse:50805.90975126884586643
[2]	train-rmse:45118.49221384151314851
[3]	train-rmse:41081.95237535334308632
[4]	train-rmse:38870.17674265824462054
[5]	train-rmse:36808.78356694047397468
[1]	train-logloss:0.62360870221829812
[2]	train-logloss:0.58373274581785828
[3]	train-logloss:0.55822905044151683
[4]	train-logloss:0.54074468446977197
[5]	train-logloss:0.52591642424712204
[1]	train-rmse:60903.80710911499772919
[2]	train-rmse:54099.31892967657768168
[3]	train-rmse:49576.11850658095499966
[4]	train-rmse:46556.65778888474596897
[5]	train-rmse:43876.91871598918805830
[1]	train-logloss:0.62742250420592738
[2]	train-logloss:0.58906182237814853
[3]	train-logloss:0.56361801188760374
[4]	train-logloss:0.54553039387071367
[5]	train-logloss:0.53199355807634419
[1]	train-rmse:58283.80948005586833460
[2]	train-rmse:52014.92906220545410179
[3]	train-rmse:47384.55433909337443765
[4]	train-rmse:44222.83196772700466681
[5]	train-rmse:42066.38531371586577734
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  8469.37     1274.65  6.64    &lt;1e-10    5970.79    10967.9
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">boost_y_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">((</span><span class="n">boost_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">.-</span> <span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">boost_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">boost_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">boost_d_rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">boost_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.^</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">println</span><span class="p">(</span><span class="n">boost_y_rmse</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="n">boost_d_rmse</span><span class="p">)</span>

<span class="n">mean</span><span class="p">(</span><span class="n">ifelse</span><span class="o">.</span><span class="p">(</span><span class="n">d</span> <span class="o">.-</span> <span class="n">boost_data</span><span class="p">[</span><span class="o">!</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">.&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.!=</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>56917.35363267462
0.44846539610140396
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3179021684316692
</pre></div>
</div>
</div>
</div>
<p>Let’s sum up the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Statistic</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Estimate&quot;</span><span class="p">,</span> <span class="s">&quot;Std.Error&quot;</span><span class="p">,</span> <span class="s">&quot;RMSE Y&quot;</span><span class="p">,</span> <span class="s">&quot;RMSE D&quot;</span><span class="p">],</span> 
    <span class="n">Lasso</span> <span class="o">=</span> <span class="p">[</span><span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">lasso_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vcov</span><span class="p">(</span><span class="n">lasso_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lasso_y_rmse</span><span class="p">,</span> <span class="n">lasso_d_rmse</span><span class="p">],</span> 
    <span class="n">RF</span> <span class="o">=</span> <span class="p">[</span><span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">rf_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vcov</span><span class="p">(</span><span class="n">rf_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">rf_y_rmse</span><span class="p">,</span> <span class="n">rf_d_rmse</span><span class="p">],</span> 
    <span class="n">Trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">tree_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vcov</span><span class="p">(</span><span class="n">tree_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tree_y_rmse</span><span class="p">,</span> <span class="n">tree_d_rmse</span><span class="p">],</span> 
    <span class="n">Boosting</span> <span class="o">=</span> <span class="p">[</span><span class="n">StatsBase</span><span class="o">.</span><span class="n">coef</span><span class="p">(</span><span class="n">boost_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vcov</span><span class="p">(</span><span class="n">boost_fit</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">boost_y_rmse</span><span class="p">,</span> <span class="n">boost_d_rmse</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="data-frame"><thead><tr><th></th><th>Statistic</th><th>Lasso</th><th>RF</th><th>Trees</th><th>Boosting</th></tr><tr><th></th><th>String</th><th>Float64</th><th>Float64</th><th>Float64</th><th>Float64</th></tr></thead><tbody><p>4 rows × 5 columns</p><tr><th>1</th><td>Estimate</td><td>6536.48</td><td>8753.48</td><td>8205.33</td><td>8469.37</td></tr><tr><th>2</th><td>Std.Error</td><td>1250.23</td><td>1214.5</td><td>1320.35</td><td>1274.65</td></tr><tr><th>3</th><td>RMSE Y</td><td>55738.2</td><td>56226.4</td><td>59676.1</td><td>56917.4</td></tr><tr><th>4</th><td>RMSE D</td><td>0.447752</td><td>0.464961</td><td>0.453928</td><td>0.448465</td></tr></tbody></table></div></div>
</div>
</section>
<section id="interactive-regression-model-irm">
<h2>Interactive Regression Model (IRM)<a class="headerlink" href="#interactive-regression-model-irm" title="Permalink to this headline">#</a></h2>
<p>Next, we consider estimation of average treatment effects when treatment effects are fully heterogeneous:</p>
<div class="math notranslate nohighlight">
\[
Y = g_0(D, X) + U, E[U | X, D] = 0,
\]</div>
<div class="math notranslate nohighlight">
\[
D = m_0(X) + V, E[V | X] = 0.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Function based off of: https://github.com/DoubleML/doubleml-for-r/blob/f00d62c722a2b1e37c01b7f7f772e9d07f452a98/R/double_ml_irm.R</span>
<span class="c">#                        https://github.com/DoubleML/doubleml-for-r/blob/f00d62c722a2b1e37c01b7f7f772e9d07f452a98/R/double_ml_plr.R</span>

<span class="c"># Function takes x, y, d, learners, and nfolds</span>

<span class="k">function</span> <span class="n">IRM_Lasso</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span> <span class="p">[(</span><span class="n">d</span> <span class="o">.&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">(</span><span class="n">d</span> <span class="o">.&gt;=</span> <span class="mf">0.5</span><span class="p">)])</span>
    
    <span class="c"># Apply learners to y_0, y_1 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">dl</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">],</span> <span class="n">outtype</span> <span class="o">=</span> <span class="ss">:prob</span><span class="p">)</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    <span class="c"># Residuals: u0_hat, u1_hat, no need for residual in d</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    
    <span class="c"># Trimming</span>
    <span class="n">d_hat</span><span class="p">[</span><span class="n">d_hat</span> <span class="o">.&lt;</span> <span class="n">trimming_threshold</span><span class="p">]</span> <span class="o">.=</span> <span class="n">trimming_threshold</span>
    <span class="n">d_hat</span><span class="p">[</span><span class="n">d_hat</span> <span class="o">.&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trimming_threshold</span><span class="p">)]</span> <span class="o">.=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">trimming_threshold</span>

    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + d * u1_hat / m_hat - (1 - d) * u0_hat / (1 - m_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">d_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: All ones</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">),</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IRM_Lasso (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Binomial</span><span class="p">())</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">lasso_fit</span><span class="p">,</span> <span class="n">lasso_data</span> <span class="o">=</span> <span class="n">IRM_Lasso</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
<span class="n">lasso_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
────────────────────────────────────────────────────────────
     Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
────────────────────────────────────────────────────────────
x1  1527.2     4241.99  0.36    0.7188   -6787.97    9842.37
────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IRM_Forest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    <span class="c"># Residuals: u0_hat, u1_hat, no need for residual in d</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + d * u1_hat / m_hat </span>
    <span class="c">#            - (1 - d) * u0_hat / (1 - m_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">d_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: All ones</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">),</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IRM_Forest (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">rf_fit</span><span class="p">,</span> <span class="n">rf_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IRM_Forest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">rf_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
──────────────────────────────────────────────────────────
    Coef.  Std. Error    t  Pr(&gt;|t|)  Lower 95%  Upper 95%
──────────────────────────────────────────────────────────
x1    NaN         NaN  NaN       NaN        NaN        NaN
──────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">psi_b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9915-element Vector{Float64}:
 NaN
 NaN
 NaN
 NaN
 NaN
  Inf
 NaN
 NaN
 NaN
 NaN
 NaN
 NaN
 NaN
   ⋮
  Inf
  Inf
 -Inf
  Inf
  Inf
 -Inf
  Inf
 NaN
 NaN
 NaN
 -Inf
 -Inf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IRM_Tree</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    <span class="c"># Residuals: u0_hat, u1_hat, no need for residual in d</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + d * u1_hat / m_hat </span>
    <span class="c">#            - (1 - d) * u0_hat / (1 - m_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">d_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: All ones</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">),</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IRM_Tree (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="n">tree_fit</span><span class="p">,</span> <span class="n">tree_data</span> <span class="o">=</span> <span class="n">IRM_Tree</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">tree_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  7137.53     1212.17  5.89    &lt;1e-08    4761.43    9513.63
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IRM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    <span class="c"># Residuals: u0_hat, u1_hat, no need for residual in d</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    
    <span class="c"># Trimming</span>
    <span class="n">d_hat</span><span class="p">[</span><span class="n">d_hat</span> <span class="o">.&lt;</span> <span class="n">trimming_threshold</span><span class="p">]</span> <span class="o">.=</span> <span class="n">trimming_threshold</span>
    <span class="n">d_hat</span><span class="p">[</span><span class="n">d_hat</span> <span class="o">.&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trimming_threshold</span><span class="p">)]</span> <span class="o">.=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">trimming_threshold</span>

    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + d * u1_hat / m_hat </span>
    <span class="c">#            - (1 - d) * u0_hat / (1 - m_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">d_hat</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: All ones</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">),</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">d</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IRM_Boost (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s">&quot;logloss&quot;</span><span class="p">);</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">y</span><span class="p">);</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IRM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1]	train-rmse:39672.55862477455229964
[2]	train-rmse:33829.13558642176212743
[3]	train-rmse:30258.46958888950393884
[4]	train-rmse:27771.90457050152326701
[5]	train-rmse:25801.52380595109571004
[1]	train-rmse:63219.98147018595773261
[2]	train-rmse:54416.80836068426287966
[3]	train-rmse:47289.68965621231473051
[4]	train-rmse:42172.63499183114618063
[5]	train-rmse:37971.38256453725625761
[1]	train-logloss:0.62814512403397260
[2]	train-logloss:0.59143994323424598
[3]	train-logloss:0.56518430078399340
[4]	train-logloss:0.54780421759510545
[5]	train-logloss:0.53631460053477098
[1]	train-rmse:50636.30439475246384973
[2]	train-rmse:43745.13860136931907618
[3]	train-rmse:38834.36631127876171377
[4]	train-rmse:35144.75589004970242968
[5]	train-rmse:32663.59513701907417271
[1]	train-rmse:73605.79290901409694925
[2]	train-rmse:65207.46431023348122835
[3]	train-rmse:58405.75253156274266075
[4]	train-rmse:53038.06686622917186469
[5]	train-rmse:49754.44319479364639847
[1]	train-logloss:0.62360870221829812
[2]	train-logloss:0.58373274581785828
[3]	train-logloss:0.55822905044151683
[4]	train-logloss:0.54074468446977197
[5]	train-logloss:0.52591642424712204
[1]	train-rmse:50005.24054598450311460
[2]	train-rmse:43400.83870381317683496
[3]	train-rmse:38966.11923426424618810
[4]	train-rmse:35379.46674831327254651
[5]	train-rmse:32324.18250056869874243
[1]	train-rmse:69200.65689350117463619
[2]	train-rmse:60404.73848133030696772
[3]	train-rmse:54678.29552286212856416
[4]	train-rmse:50607.39462431120045949
[5]	train-rmse:47160.13022250941139646
[1]	train-logloss:0.62742250420592738
[2]	train-logloss:0.58906182237814853
[3]	train-logloss:0.56361801188760374
[4]	train-logloss:0.54553039387071367
[5]	train-logloss:0.53199355807634419
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  7955.78      1175.3  6.77    &lt;1e-10    5651.95    10259.6
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
</section>
<section id="local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
<h2>Local Average Treatment Effects of 401(k) Participation on Net Financial Assets<a class="headerlink" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets" title="Permalink to this headline">#</a></h2>
</section>
<section id="interactive-iv-model-iivm">
<h2>Interactive IV Model (IIVM)<a class="headerlink" href="#interactive-iv-model-iivm" title="Permalink to this headline">#</a></h2>
<p>Now, we consider estimation of local average treatment effects (LATE) with the binary instrument 401. As before, <span class="math notranslate nohighlight">\(Y\)</span> denotes the outcome <code class="docutils literal notranslate"><span class="pre">net_tfa</span></code>, and <span class="math notranslate nohighlight">\(X\)</span> is the vector of covariates. Here, the structural equation model is:</p>
<div class="math notranslate nohighlight">
\[
Y = g_0(Z, X) + U, E[U | Z, X] = 0,
\]</div>
<div class="math notranslate nohighlight">
\[
D = r_0(Z, X) + V, E[V | Z, X] = 0,
\]</div>
<div class="math notranslate nohighlight">
\[
Z = m_0(X) + \zeta, E[\zeta | X] = 0.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">formula_iivm</span> <span class="o">=</span> <span class="nd">@formula</span><span class="p">(</span><span class="n">net_tfa</span> <span class="o">~</span> <span class="n">p401</span> <span class="o">+</span> <span class="n">e401</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">educ</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">poly</span><span class="p">(</span><span class="n">fsize</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">marr</span> <span class="o">+</span> <span class="n">twoearn</span> <span class="o">+</span> <span class="n">db</span> <span class="o">+</span> <span class="n">pira</span> <span class="o">+</span> <span class="n">hown</span><span class="p">);</span>
<span class="n">formula_iivm</span> <span class="o">=</span> <span class="n">apply_schema</span><span class="p">(</span><span class="n">formula_iivm</span><span class="p">,</span> <span class="n">schema</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">modelcols</span><span class="p">(</span><span class="n">formula_iivm</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="n">d</span> <span class="o">=</span> <span class="kt">Integer</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span>
<span class="n">z</span> <span class="o">=</span> <span class="kt">Integer</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">:</span><span class="p">,</span> <span class="n">Not</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])];</span>
<span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IIVM_Lasso</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d0_hat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">z_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="n">dl</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span> <span class="p">[(</span><span class="n">d</span> <span class="o">.&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">(</span><span class="n">d</span> <span class="o">.&gt;=</span> <span class="mf">0.5</span><span class="p">)])</span>
    <span class="n">zl</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span> <span class="p">[(</span><span class="n">z</span> <span class="o">.&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">(</span><span class="n">z</span> <span class="o">.&gt;=</span> <span class="mf">0.5</span><span class="p">)])</span>
    
    <span class="c"># Apply learners to y_0, y_1, d_1, d_2 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">r1_hat</span> <span class="o">=</span> <span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">dl</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">zl</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">r1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">],</span> <span class="n">outtype</span> <span class="o">=</span> <span class="ss">:prob</span><span class="p">)</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">z_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">GLMNet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">],</span> <span class="n">outtype</span> <span class="o">=</span> <span class="ss">:prob</span><span class="p">)</span>
    
    <span class="k">end</span>
    
    
    <span class="c"># Residuals: u0_hat, u1_hat, w0_hat, and w1_hat; no need for residual in z</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    <span class="n">w0_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d0_hat</span>
    <span class="n">w1_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + z * (u1_hat) / z_hat - (1 - z) * u0_hat / (1 - z_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: d1_hat - d0_hat + z * (w1_hat) / z_hat - (1 - z) * w0_hat / (1 - z_hat)</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">d1_hat</span> <span class="o">.-</span> <span class="n">d0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">psi_a</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IIVM_Lasso (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Binomial</span><span class="p">());</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">nfolds</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Binomial</span><span class="p">());</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IIVM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">MethodError</span>: no method matching glmnet!(::Matrix{Float64}, ::Vector{Float64}, ::Binomial{Float64}; weights=[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], offsets=[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0])
<span class="n">Closest</span> <span class="n">candidates</span> <span class="n">are</span><span class="p">:</span>
  <span class="n">glmnet</span><span class="o">!(</span>::Matrix<span class="o">{</span>Float64<span class="o">}</span>, ::Matrix<span class="o">{</span>Float64<span class="o">}</span>, ::Binomial<span class="p">;</span> offsets, weights, alpha, penalty_factor, constraints, dfmax, pmax, nlambda, lambda_min_ratio, lambda, tol, standardize, intercept, maxit, algorithm<span class="o">)</span> at C:<span class="se">\U</span>sers<span class="se">\W</span>ork<span class="se">\.</span>julia<span class="se">\p</span>ackages<span class="se">\G</span>LMNet<span class="se">\C</span>8WKF<span class="se">\s</span>rc<span class="se">\G</span>LMNet.jl:337
  <span class="n">glmnet</span><span class="o">!(</span>::Matrix<span class="o">{</span>Float64<span class="o">}</span>, ::Vector<span class="o">{</span>Float64<span class="o">})</span> at C:<span class="se">\U</span>sers<span class="se">\W</span>ork<span class="se">\.</span>julia<span class="se">\p</span>ackages<span class="se">\G</span>LMNet<span class="se">\C</span>8WKF<span class="se">\s</span>rc<span class="se">\G</span>LMNet.jl:271 got unsupported keyword arguments <span class="s2">&quot;weights&quot;</span>, <span class="s2">&quot;offsets&quot;</span>
  <span class="n">glmnet</span><span class="o">!(</span>::Matrix<span class="o">{</span>Float64<span class="o">}</span>, ::Vector<span class="o">{</span>Float64<span class="o">}</span>, ::Normal<span class="p">;</span> weights, naivealgorithm, alpha, penalty_factor, constraints, dfmax, pmax, nlambda, lambda_min_ratio, lambda, tol, standardize, intercept, maxit<span class="o">)</span> at C:<span class="se">\U</span>sers<span class="se">\W</span>ork<span class="se">\.</span>julia<span class="se">\p</span>ackages<span class="se">\G</span>LMNet<span class="se">\C</span>8WKF<span class="se">\s</span>rc<span class="se">\G</span>LMNet.jl:271 got unsupported keyword argument <span class="s2">&quot;offsets&quot;</span>
  <span class="o">...</span>

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">glmnet</span><span class="p">(</span><span class="n">X</span><span class="p">::</span><span class="n">Matrix</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">family</span><span class="p">::</span><span class="n">Binomial</span><span class="p">{</span><span class="n">Float64</span><span class="p">};</span> <span class="n">kw</span><span class="p">::</span><span class="n">Base</span><span class="o">.</span><span class="n">Pairs</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Vector</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">},</span> <span class="n">NamedTuple</span><span class="p">{(:</span><span class="n">weights</span><span class="p">,</span> <span class="p">:</span><span class="n">offsets</span><span class="p">),</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">Vector</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">Vector</span><span class="p">{</span><span class="n">Float64</span><span class="p">}}}})</span>
   <span class="o">@</span> <span class="n">GLMNet</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Work</span>\<span class="o">.</span><span class="n">julia</span>\<span class="n">packages</span>\<span class="n">GLMNet</span>\<span class="n">C8WKF</span>\<span class="n">src</span>\<span class="n">GLMNet</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">485</span>
 <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">glmnetcv</span><span class="p">(</span><span class="n">X</span><span class="p">::</span><span class="n">Matrix</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">family</span><span class="p">::</span><span class="n">Binomial</span><span class="p">{</span><span class="n">Float64</span><span class="p">};</span> <span class="n">weights</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">offsets</span><span class="p">::</span><span class="n">Nothing</span><span class="p">,</span> <span class="n">rng</span><span class="p">::</span><span class="n">Random</span><span class="o">.</span><span class="n">_GLOBAL_RNG</span><span class="p">,</span> <span class="n">nfolds</span><span class="p">::</span><span class="n">Int64</span><span class="p">,</span> <span class="n">folds</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">parallel</span><span class="p">::</span><span class="n">Bool</span><span class="p">,</span> <span class="n">grouped</span><span class="p">::</span><span class="n">Bool</span><span class="p">,</span> <span class="n">kw</span><span class="p">::</span><span class="n">Base</span><span class="o">.</span><span class="n">Pairs</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Union</span><span class="p">{},</span> <span class="n">Tuple</span><span class="p">{},</span> <span class="n">NamedTuple</span><span class="p">{(),</span> <span class="n">Tuple</span><span class="p">{}}})</span>
   <span class="o">@</span> <span class="n">GLMNet</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">Work</span>\<span class="o">.</span><span class="n">julia</span>\<span class="n">packages</span>\<span class="n">GLMNet</span>\<span class="n">C8WKF</span>\<span class="n">src</span>\<span class="n">GLMNet</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">543</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">::</span><span class="n">Matrix</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">d</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">})</span>
   <span class="o">@</span> <span class="n">Main</span> <span class="o">.</span>\<span class="n">In</span><span class="p">[</span><span class="mi">146</span><span class="p">]:</span><span class="mi">3</span>
 <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">IIVM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">::</span><span class="n">Matrix</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int32</span><span class="p">},</span> <span class="n">d</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">z</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">ml_g</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">ml_g</span><span class="p">),</span> <span class="n">ml_r</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">ml_r</span><span class="p">),</span> <span class="n">ml_m</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">ml_m</span><span class="p">),</span> <span class="n">nfold</span><span class="p">::</span><span class="n">Int64</span><span class="p">,</span> <span class="n">trimming_threshold</span><span class="p">::</span><span class="n">Float64</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Main</span> <span class="o">.</span>\<span class="n">In</span><span class="p">[</span><span class="mi">139</span><span class="p">]:</span><span class="mi">26</span>
 <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">IIVM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">::</span><span class="n">Matrix</span><span class="p">{</span><span class="n">Float64</span><span class="p">},</span> <span class="n">y</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int32</span><span class="p">},</span> <span class="n">d</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">z</span><span class="p">::</span><span class="n">Vector</span><span class="p">{</span><span class="n">Int64</span><span class="p">},</span> <span class="n">ml_g</span><span class="p">::</span><span class="n">Function</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">::</span><span class="n">Function</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">::</span><span class="n">Function</span><span class="p">,</span> <span class="n">nfold</span><span class="p">::</span><span class="n">Int64</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Main</span> <span class="o">.</span>\<span class="n">In</span><span class="p">[</span><span class="mi">139</span><span class="p">]:</span><span class="mi">4</span>
 <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">146</span><span class="p">]:</span><span class="mi">7</span>
 <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="nb">eval</span>
   <span class="o">@</span> <span class="o">.</span>\<span class="n">boot</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">373</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">include_string</span><span class="p">(</span><span class="n">mapexpr</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">REPL</span><span class="o">.</span><span class="n">softscope</span><span class="p">),</span> <span class="n">mod</span><span class="p">::</span><span class="n">Module</span><span class="p">,</span> <span class="n">code</span><span class="p">::</span><span class="n">String</span><span class="p">,</span> <span class="n">filename</span><span class="p">::</span><span class="n">String</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Base</span> <span class="o">.</span>\<span class="n">loading</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">1196</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IIVM_Forest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d0_hat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">z_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1, d_1, d_2 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">r1_hat</span> <span class="o">=</span> <span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">r1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">z_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_forest</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    
    <span class="c"># Residuals: u0_hat, u1_hat, w0_hat, and w1_hat; no need for residual in z</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    <span class="n">w0_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d0_hat</span>
    <span class="n">w1_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + z * (u1_hat) / z_hat - (1 - z) * u0_hat / (1 - z_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: d1_hat - d0_hat + z * (w1_hat) / z_hat - (1 - z) * w0_hat / (1 - z_hat)</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">d1_hat</span> <span class="o">.-</span> <span class="n">d0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">psi_a</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IIVM_Forest (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_forest</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IIVM_Forest</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
──────────────────────────────────────────────────────────
    Coef.  Std. Error    t  Pr(&gt;|t|)  Lower 95%  Upper 95%
──────────────────────────────────────────────────────────
x1    0.0         NaN  NaN       NaN        NaN        NaN
──────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IIVM_Tree</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d0_hat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">z_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1, d_1, d_2 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">r1_hat</span> <span class="o">=</span> <span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">r1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">z_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">apply_tree</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    
    <span class="c"># Residuals: u0_hat, u1_hat, w0_hat, and w1_hat; no need for residual in z</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    <span class="n">w0_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d0_hat</span>
    <span class="n">w1_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + z * (u1_hat) / z_hat - (1 - z) * u0_hat / (1 - z_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: d1_hat - d0_hat + z * (w1_hat) / z_hat - (1 - z) * w0_hat / (1 - z_hat)</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">d1_hat</span> <span class="o">.-</span> <span class="n">d0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">psi_a</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IIVM_Tree (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">build_tree</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IIVM_Tree</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
──────────────────────────────────────────────────────────
    Coef.  Std. Error    t  Pr(&gt;|t|)  Lower 95%  Upper 95%
──────────────────────────────────────────────────────────
x1    0.0         NaN  NaN       NaN        NaN        NaN
──────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">psi_b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9915-element Vector{Float64}:
 NaN
 NaN
 NaN
 NaN
 NaN
  Inf
 NaN
 NaN
 NaN
 NaN
 NaN
 NaN
 NaN
   ⋮
  Inf
  Inf
 -Inf
  Inf
  Inf
 -Inf
  Inf
 NaN
 NaN
 NaN
 -Inf
 -Inf
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">IIVM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">nfold</span><span class="p">,</span> <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span>
    
    <span class="c"># Sample size</span>
    <span class="n">nobser</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c"># Fold indexes</span>
    <span class="n">foldid</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">Kfold</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nfold</span><span class="p">))</span>
    
    <span class="c"># Initialize vectors for predictions</span>
    <span class="n">y0_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">y1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d0_hat</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">d1_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    <span class="n">z_hat</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">nobser</span><span class="p">)</span>
    
    <span class="c"># Apply learners to y_0, y_1, d_1, d_2 and d separately</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">nfold</span>
        <span class="c"># Create y_0 and y_1 for this fold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="o">==</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">smp_1</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">smp_0</span> <span class="o">=</span> <span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">Not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span>
        
        <span class="c"># Model Learning</span>
        <span class="n">g0_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_0</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_0</span><span class="p">])</span>
        <span class="n">g1_hat</span> <span class="o">=</span> <span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">r1_hat</span> <span class="o">=</span> <span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">smp_1</span><span class="p">,</span> <span class="o">:</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">smp_1</span><span class="p">])</span>
        <span class="n">m_hat</span> <span class="o">=</span> <span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">:</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="c"># Predict: g0_hat, g1_hat, m_hat</span>
        <span class="n">d1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">r1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y0_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g0_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">y1_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">g1_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
        <span class="n">z_hat</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">XGBoost</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m_hat</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">Not</span><span class="p">(</span><span class="n">foldid</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="o">:</span><span class="p">])</span>
    
    <span class="k">end</span>
    
    
    <span class="c"># Residuals: u0_hat, u1_hat, w0_hat, and w1_hat; no need for residual in z</span>
    <span class="n">u0_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y0_hat</span>
    <span class="n">u1_hat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">.-</span> <span class="n">y1_hat</span>
    <span class="n">w0_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d0_hat</span>
    <span class="n">w1_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">.-</span> <span class="n">d1_hat</span>
    
    <span class="c"># Compute regression terms:</span>
    <span class="c"># Left side: y1_hat - y0_hat + z * (u1_hat) / z_hat - (1 - z) * u0_hat / (1 - z_hat)</span>
    <span class="n">psi_b</span> <span class="o">=</span> <span class="n">y1_hat</span> <span class="o">.-</span> <span class="n">y0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Right side: d1_hat - d0_hat + z * (w1_hat) / z_hat - (1 - z) * w0_hat / (1 - z_hat)</span>
    <span class="n">psi_a</span> <span class="o">=</span> <span class="n">d1_hat</span> <span class="o">.-</span> <span class="n">d0_hat</span> <span class="o">.+</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">./</span> <span class="n">z_hat</span> <span class="o">.-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span> <span class="o">./</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z_hat</span><span class="p">)</span>
    
    <span class="c"># Regression with fit(LinearModel, ...)</span>
    <span class="n">rfit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">LinearModel</span><span class="p">,</span> <span class="n">reshape</span><span class="p">(</span><span class="n">psi_a</span><span class="p">,</span> <span class="n">nobser</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">psi_b</span><span class="p">)</span>
    
    <span class="c"># Generate data matrix for output</span>
    <span class="n">u_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">u1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">u0_hat</span>
    <span class="n">d_til</span> <span class="o">=</span> <span class="n">z</span> <span class="o">.*</span> <span class="n">w1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">.-</span> <span class="n">z</span><span class="p">)</span> <span class="o">.*</span> <span class="n">w0_hat</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">u_hat</span> <span class="o">=</span> <span class="n">u_hat</span><span class="p">,</span> <span class="n">d_til</span> <span class="o">=</span> <span class="n">d_til</span><span class="p">)</span>
    
    <span class="c"># Function outputs residual data and ATE</span>
    <span class="k">return</span> <span class="n">rfit</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span><span class="p">;</span>
    
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>IIVM_Boost (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Random</span><span class="o">.</span><span class="n">seed!</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">ml_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">d</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s">&quot;logloss&quot;</span><span class="p">);</span>
<span class="n">ml_g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">y</span><span class="p">);</span>
<span class="n">ml_m</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">xgboost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">z</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s">&quot;logloss&quot;</span><span class="p">);</span>

<span class="n">boost_fit</span><span class="p">,</span> <span class="n">boost_data</span><span class="p">,</span> <span class="n">psi_a</span><span class="p">,</span> <span class="n">psi_b</span> <span class="o">=</span> <span class="n">IIVM_Boost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ml_g</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">boost_fit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1]	train-rmse:38737.01316460889211157
[2]	train-rmse:33304.54192929357668618
[3]	train-rmse:30087.88246757425804390
[4]	train-rmse:27682.53218891132928547
[5]	train-rmse:25969.88210150778104435
[1]	train-rmse:72572.35164468456059694
[2]	train-rmse:60784.81608743120159488
[3]	train-rmse:52507.22102924608770991
[4]	train-rmse:45813.72014589509490179
[5]	train-rmse:41249.85934676897886675
[1]	train-logloss:0.43798348307609558
[2]	train-logloss:0.29688626527786255
[3]	train-logloss:0.20793505012989044
[4]	train-logloss:0.14840467274188995
[5]	train-logloss:0.10719931125640869
[1]	train-logloss:0.60419132046728374
[2]	train-logloss:0.55244129131042286
[3]	train-logloss:0.52205823458584644
[4]	train-logloss:0.50040258928209136
[5]	train-logloss:0.48396389952180247
[1]	train-rmse:52097.06435315485578030
[2]	train-rmse:45438.81816587039793376
[3]	train-rmse:40529.84053594780561980
[4]	train-rmse:36828.59269390138797462
[5]	train-rmse:34190.20507247609930346
[1]	train-rmse:76699.46711005464021582
[2]	train-rmse:66159.79872236897062976
[3]	train-rmse:58604.30054447607108159
[4]	train-rmse:53187.39922854965698207
[5]	train-rmse:48078.70394358545308933
[1]	train-logloss:0.43798089027404785
[2]	train-logloss:0.29688304662704468
[3]	train-logloss:0.20793174207210541
[4]	train-logloss:0.14840149879455566
[5]	train-logloss:0.10719606280326843
[1]	train-logloss:0.60079734626137360
[2]	train-logloss:0.54891287613654460
[3]	train-logloss:0.51822749015152370
[4]	train-logloss:0.49740344255080560
[5]	train-logloss:0.48021829179664244
[1]	train-rmse:51520.86249363672686741
[2]	train-rmse:44869.64527681432809914
[3]	train-rmse:40060.30865430940320948
[4]	train-rmse:36389.44057544340466848
[5]	train-rmse:33519.42267165944940643
[1]	train-rmse:70127.85160157522477675
[2]	train-rmse:60656.04893145235837437
[3]	train-rmse:54494.32637024657014990
[4]	train-rmse:48895.69543426703603473
[5]	train-rmse:45360.65633690952381585
[1]	train-logloss:0.43797209858894348
[2]	train-logloss:0.29687252640724182
[3]	train-logloss:0.20792074501514435
[4]	train-logloss:0.14839050173759460
[5]	train-logloss:0.10718551278114319
[1]	train-logloss:0.60325615585932391
[2]	train-logloss:0.55267446944645060
[3]	train-logloss:0.52069095989489156
[4]	train-logloss:0.49739827184110835
[5]	train-logloss:0.48003386232477813
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}:

Coefficients:
─────────────────────────────────────────────────────────────
      Coef.  Std. Error     t  Pr(&gt;|t|)  Lower 95%  Upper 95%
─────────────────────────────────────────────────────────────
x1  12176.7     1268.88  9.60    &lt;1e-20    9689.49    14664.0
─────────────────────────────────────────────────────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">DecisionTree</span><span class="o">.</span><span class="n">fit!</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier
max_depth:                2
min_samples_leaf:         1
min_samples_split:        2
min_purity_increase:      0.0
pruning_purity_threshold: 1.0
n_subfeatures:            0
classes:                  [0, 1]
root:                     Decision Tree
Leaves: 4
Depth:  2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">predict_proba</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)[</span><span class="o">:</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9915-element Vector{Float64}:
 0.15991116046640755
 0.43381136238279094
 0.43381136238279094
 0.43381136238279094
 0.6444823663253697
 0.6444823663253697
 0.6444823663253697
 0.15991116046640755
 0.15991116046640755
 0.15991116046640755
 0.6444823663253697
 0.43381136238279094
 0.43381136238279094
 ⋮
 0.43381136238279094
 0.43381136238279094
 0.43381136238279094
 0.15991116046640755
 0.15991116046640755
 0.43381136238279094
 0.43381136238279094
 0.43057050592034446
 0.6444823663253697
 0.43381136238279094
 0.6444823663253697
 0.15991116046640755
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DecisionTree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9915-element Vector{Int64}:
 0
 0
 0
 0
 1
 1
 1
 0
 0
 0
 1
 0
 0
 ⋮
 0
 0
 0
 0
 0
 0
 0
 0
 1
 0
 1
 0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">print_tree</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Feature 7 &lt; 29000.0 ?
├─ Feature 23 &lt; 0.5 ?
    ├─ 0 : 3026/3602
    └─ 0 : 529/929
└─ Feature 23 &lt; 0.5 ?
    ├─ 0 : 2053/3626
    └─ 1 : 1133/1758
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.7"
        },
        kernelOptions: {
            kernelName: "julia-1.7",
            path: "./contents"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.7'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Jupyter Book Community<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>